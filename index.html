<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="BibliotecaAudios"/>
  <title>Biblioteca de audios</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial}
    body{margin:0;background:linear-gradient(180deg,#071025 0%,#0b1220 100%);color:#e6eef6}
    header{display:flex;gap:.5rem;padding:1rem;background:rgba(255,255,255,.02);align-items:center;position:sticky;top:0;z-index:10}
    .tabs{display:flex;gap:.4rem;flex-wrap:wrap;margin: 0 auto;}
    .tab{background:transparent;border:1px solid rgba(255,255,255,.06);padding:.5rem .8rem;border-radius:.5rem;cursor:pointer;color:var(--muted);}
    .tab.active{background:linear-gradient(90deg,var(--accent),#7dd3fc);color:#042022;border:1px solid rgba(255,255,255,.06);font-weight:600}
    main{padding:1rem;max-width:1200px;margin:1rem auto}
    .layout{display:grid;grid-template-columns:300px 1fr;gap:1rem;align-items:start}
    .imagen-card{width: 250px;height: auto;display: block;margin: 0 auto;}
    .left-panel{padding:.1rem;border-radius:.6rem;background:transparent;color:var(--muted);position:sticky;top:76px;height:calc(100vh - 96px);overflow:auto;}
    .panel-section{margin-bottom:1.25rem;padding:.75rem;border-radius:.5rem;background:rgba(28, 41, 66, 0.6)}
    .panel-section h3{margin:.1rem 0 .6rem 0;color:#e6eef6;font-size:1rem}
    .card{background:var(--card);padding:1rem;border-radius:.6rem;box-shadow:0 6px 18px rgba(2,6,23,.6)}
    .audios{display:flex;flex-direction:column;gap:.6rem}
    .audio-item{display:flex;align-items:center;gap:.6rem;justify-content:space-between;background:rgba(255,255,255,.02);padding:.5rem;border-radius:.45rem}
    .small{font-size:.85rem;color:var(--muted)}
    .FECHASELECCIONADA{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    .uploader{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    input[type=file]{display:inline-block}
    .meta-form{margin-top:.6rem;padding:.6rem;border-radius:.45rem;background:rgba(255,255,255,.02);display:none;flex-direction:column;gap:.5rem}
    .meta-row{display:flex;gap:.5rem;align-items:center}
    .meta-row > *{flex:1}
    .btn{padding:.45rem .6rem;border-radius:.4rem;border:0;cursor:pointer}
    .btn-primary{background:var(--accent);color:#042022}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--muted)}
    @media(max-width:900px){
      .layout{grid-template-columns:1fr; }
      .left-panel{position:relative;top:0;height:auto}
      .imagen-card{width:160px}
    }
  </style>
</head>
<body>
  <header>
    <nav class="tabs" role="tablist" aria-label="Categorías">
      <button class="tab active" data-target="Radio1" role="tab">Radio 1</button>
      <button class="tab" data-target="Radio2" role="tab">Radio 2</button>
      <button class="tab" data-target="Radio3" role="tab">Radio 3</button>
      <button class="tab" data-target="Radio4" role="tab">Radio 4</button>
      <button class="tab" data-target="Radio5" role="tab">Radio 5</button>
    </nav>
  </header>

  <main>
    <div class="layout">
      <!-- PANEL IZQUIERDO (siempre visible) -->
      <aside class="left-panel" id="left-panel">
        <div class="panel-section" id="uploader-panel">
          <h3>UPLOADER DE ARCHIVOS DE AUDIO</h3>
          <p class="small">Categoría activa: <span id="active-name">Radio 1</span></p>
          <div style="height:8px"></div>

          <div class="uploader">
            <input id="file-input-u" type="file" accept="audio/*" multiple />
            <select id="select-cat-u" aria-label="Seleccionar categoría para subir">
              <option value="Radio1">Radio 1</option>
              <option value="Radio2">Radio 2</option>
              <option value="Radio3">Radio 3</option>
              <option value="Radio4">Radio 4</option>
              <option value="Radio5">Radio 5</option>
            </select>
            <button id="prepare-meta-btn" class="btn btn-ghost">Agregar metadatos</button>
          </div>

          <!-- formulario para fecha/hora/radio antes de guardar -->
          <div class="meta-form" id="meta-form">
            <div class="meta-row">
              <label for="meta-fecha" class="small">Fecha</label>
              <input id="meta-fecha" type="date">
            </div>
            <div class="meta-row">
              <label class="small">Inicio</label>
              <input id="meta-start" type="time">
              <label class="small">Fin</label>
              <input id="meta-end" type="time">
            </div>
            <div class="meta-row">
              <label class="small">Radio</label>
              <select id="meta-radio">
                <option value="Radio 1">Radio 1</option>
                <option value="Radio 2">Radio 2</option>
                <option value="Radio 3">Radio 3</option>
                <option value="Radio 4">Radio 4</option>
                <option value="Radio 5">Radio 5</option>
              </select>
            </div>
            <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.4rem">
              <button id="cancel-meta" class="btn btn-ghost">Cancelar</button>
              <button id="save-meta" class="btn btn-primary">Guardar audios</button>
            </div>
          </div>
        </div>

        <div class="panel-section" id="fecha-panel">
          <h3 id="fecha-title">Fecha: </h3>
          <div style="height:8px"></div>
          <div class="FECHASELECCIONADA">
            <input type="date" id="input-fecha"/>
            <button id="btn-guardar-fecha" class="btn btn-primary">Aplicar</button>
            <button id="btn-clear-fecha" class="btn btn-ghost">Mostrar todas</button>
          </div>
          <div style="height:10px"></div>
          <p class="small">Fecha seleccionada: <span id="fecha-activa">--</span></p>
        </div>
      </aside>

      <!-- CONTENIDO PRINCIPAL (secciones por radio) -->
      <section id="main-content">
        <div class="card" id="Radio1" data-cat>
          <img src="imagenes/LOGO-MICASINO-PNG.png.webp" class="imagen-card" alt="logo">
          <div class="audios" id="list-Radio1"></div>
        </div>

        <div class="card" id="Radio2" data-cat hidden>
          <img src="imagenes/LOGO-MICASINO-PNG.png.webp" class="imagen-card" alt="logo">
          <div class="audios" id="list-Radio2"></div>
        </div>

        <div class="card" id="Radio3" data-cat hidden>
          <img src="imagenes/LOGO-MICASINO-PNG.png.webp" class="imagen-card" alt="logo">
          <div class="audios" id="list-Radio3"></div>
        </div>

        <div class="card" id="Radio4" data-cat hidden>
          <img src="imagenes/LOGO-MICASINO-PNG.png.webp" class="imagen-card" alt="logo">
          <div class="audios" id="list-Radio4"></div>
        </div>

        <div class="card" id="Radio5" data-cat hidden>
          <img src="imagenes/LOGO-MICASINO-PNG.png.webp" class="imagen-card" alt="logo">
          <div class="audios" id="list-Radio5"></div>
        </div>
      </section>
    </div>
  </main>

<script>
/* ---------- Helpers: formato fecha ---------- */
function formatDateDisplay(isoDate){
  if(!isoDate) return '--';
  try {
    const d = new Date(isoDate + 'T00:00:00');
    return d.toLocaleDateString();
  } catch(e){
    return isoDate;
  }
}

/* ---------- IndexedDB helper para archivos (almacena blobs/files) ---------- */
function openIDB(){
  return new Promise((res, rej) => {
    const req = indexedDB.open('biblioteca_audios_db', 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains('files')) db.createObjectStore('files', { keyPath: 'id' });
    };
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}
async function idbStoreFile(id, file){
  const db = await openIDB();
  return new Promise((res, rej) => {
    const tx = db.transaction('files', 'readwrite');
    const store = tx.objectStore('files');
    // guardamos {id, file} (File/Blob es clonable)
    const putReq = store.put({ id, file });
    putReq.onsuccess = () => {};
    tx.oncomplete = () => res();
    tx.onerror = () => rej(tx.error || putReq.error);
  });
}
async function idbGetFile(id){
  const db = await openIDB();
  return new Promise((res, rej) => {
    const tx = db.transaction('files', 'readonly');
    const r = tx.objectStore('files').get(id);
    r.onsuccess = () => {
      const rec = r.result;
      if(!rec){
        res(null);
        return;
      }
      const possible = rec.file ?? rec.blob ?? rec;
      res(possible);
    };
    r.onerror = () => rej(r.error);
  });
}

/* ---------- Storage metadata en localStorage (sin dataUrl) ---------- */
const STORAGE_KEY = 'biblioteca_audios_v1';
function saveStorage(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}
function loadStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  }catch(e){
    console.error('loadStorage error', e);
    return [];
  }
}

/* ---------- UID ---------- */
function uid(){
  return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
}

/* ---------- UI elementos ---------- */
const tabs = document.querySelectorAll('.tab');
const cats = document.querySelectorAll('[data-cat]');
const activeNameSpan = document.getElementById('active-name');

const fileInput = document.getElementById('file-input-u');
const prepareMetaBtn = document.getElementById('prepare-meta-btn');
const metaForm = document.getElementById('meta-form');
const metaFecha = document.getElementById('meta-fecha');
const metaStart = document.getElementById('meta-start');
const metaEnd = document.getElementById('meta-end');
const metaRadio = document.getElementById('meta-radio');
const cancelMeta = document.getElementById('cancel-meta');
const saveMeta = document.getElementById('save-meta');
const selectCatU = document.getElementById('select-cat-u');

const inputFecha= document.getElementById('input-fecha');
const btnGuardarFecha= document.getElementById('btn-guardar-fecha');
const btnClearFecha= document.getElementById('btn-clear-fecha');
const fechaActivaSpan= document.getElementById('fecha-activa');
const fechaTitle= document.getElementById('fecha-title');

/* ---------- Estado ---------- */
let audios = loadStorage(); // metadata: {id,name,size,date,start,end,radio,fileId}
let filterFecha = null;

/* ---------- Tabs handling ---------- */
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const target = t.dataset.target;
  cats.forEach(c => {
    c.id === target ? c.removeAttribute('hidden') : c.setAttribute('hidden','');
  });
  activeNameSpan.textContent = t.textContent;
  if(selectCatU) selectCatU.value = target;
  if(metaRadio) metaRadio.value = t.textContent;
}));

/* ---------- Render (async porque pide blobs desde IDB) ---------- */
async function renderAll(){
  const lists = {
    Radio1: document.getElementById('list-Radio1'),
    Radio2: document.getElementById('list-Radio2'),
    Radio3: document.getElementById('list-Radio3'),
    Radio4: document.getElementById('list-Radio4'),
    Radio5: document.getElementById('list-Radio5'),
  };
  Object.values(lists).forEach(l=> l && (l.innerHTML = ''));

  const filtered = audios.filter(a => {
    if(!filterFecha) return true;
    return a.date === filterFecha;
  });

  // agrupar por radio ("Radio 1" -> "Radio1")
  const byRadio = {};
  for(const a of filtered){
    const radioKey = a.radio.replace(/\s+/g,''); // "Radio 1" -> "Radio1"
    if(!byRadio[radioKey]) byRadio[radioKey]=[];
    byRadio[radioKey].push(a);
  }

  for(const key in byRadio){
    byRadio[key].sort((x,y) => {
      if(!x.start) return 1;
      if(!y.start) return -1;
      return x.start.localeCompare(y.start);
    });
    const listEl = lists[key];
    if(!listEl) continue;
    for(const item of byRadio[key]){
      const node = document.createElement('div');
      node.className = 'audio-item';
      const startText = item.start ? item.start : '--:--';
      const endText = item.end ? item.end : '--:--';
      node.innerHTML = `
        <div>
          <strong>${startText} / ${endText}</strong>
          <div class="small">${item.radio}</div>
          <div class="small">Fecha: ${formatDateDisplay(item.date)}</div>
          <div class="small">Nombre: ${item.name}</div>
        </div>
        <audio controls></audio>
      `;
      listEl.appendChild(node);

      (async () => {
        try{
          const file = await idbGetFile(item.fileId);
          const audioEl = node.querySelector('audio');
          if(!audioEl){
            console.warn('audio element no encontrado para item', item);
            return;
          }
          if(!file){
            audioEl.outerHTML = '<div class="small">Archivo no disponible</div>';
            return;
          }
          if(typeof file === 'string'){
            audioEl.src = file;
          } else {
            const blobUrl = URL.createObjectURL(file);
            audioEl.src = blobUrl;
            // opcional: almacenar url para revocar después si se desea
            audioEl.dataset._blobUrl = blobUrl;
          }
          // forzar recarga del control
          audioEl.load();
        }catch(err){
          console.error('Error cargando audio desde IDB', err, item);
          const audioEl = node.querySelector('audio');
          if(audioEl) audioEl.outerHTML = '<div class="small">Error cargando archivo</div>';
        }
      })();
    }
  }
}

/* ---------- Preparar formulario meta ---------- */
prepareMetaBtn.addEventListener('click', () => {
  if(!fileInput.files || !fileInput.files.length) {
    alert('Selecciona al menos un archivo antes de agregar metadatos.');
    return;
  }
  const todayIso = new Date().toISOString().slice(0,10);
  metaFecha.value = inputFecha.value || todayIso;
  const sel = selectCatU.value || 'Radio1';
  const radioText = sel.replace(/Radio(\d+)/, 'Radio $1');
  metaRadio.value = radioText;
  metaForm.style.display = 'flex';
});
cancelMeta.addEventListener('click', () => metaForm.style.display = 'none');

/* ---------- Guardar audios: almacenar archivos en IDB y metadata en localStorage ---------- */
saveMeta.addEventListener('click', async () => {
  const files = Array.from(fileInput.files || []);
  if(!files.length) return;
  const fecha = metaFecha.value;
  const start = metaStart.value;
  const end = metaEnd.value;
  const radio = metaRadio.value;
  if(!fecha){ alert('Selecciona una fecha.'); return; }

  try{
    for(const f of files){
      const fileId = uid();
      await idbStoreFile(fileId, f); // guarda blob en IDB
      const entry = {
        id: uid(),
        name: f.name,
        size: f.size,
        date: fecha,
        start: start || null,
        end: end || null,
        radio: radio,
        fileId: fileId
      };
      audios.push(entry);
    }
    saveStorage(audios);
    fileInput.value = '';
    metaForm.style.display = 'none';
    await renderAll();
  }catch(e){
    console.error('error saving', e);
    alert('Error guardando archivos: ' + (e && e.message ? e.message : e));
  }
});

/* ---------- Date filter ---------- */
function actualizarFechaSeleccionada(valorIso){
  if(!valorIso){
    filterFecha = null;
    fechaActivaSpan.textContent = '--';
    fechaTitle.textContent = 'Fecha: ';
  }else{
    filterFecha = valorIso;
    const texto = formatDateDisplay(valorIso);
    fechaActivaSpan.textContent = texto;
    fechaTitle.textContent = 'Fecha: ' + texto;
  }
  renderAll();
}
inputFecha.addEventListener('change', () => {
  const val = inputFecha.value;
  fechaActivaSpan.textContent = val ? formatDateDisplay(val) : '--';
});
btnGuardarFecha.addEventListener('click', () => actualizarFechaSeleccionada(inputFecha.value || null));
btnClearFecha.addEventListener('click', () => { inputFecha.value=''; actualizarFechaSeleccionada(null); });

/* ---------- Init ---------- */
(function init(){
  const activeTab = document.querySelector('.tab.active');
  if(activeTab){
    const val = activeTab.dataset.target;
    if(selectCatU) selectCatU.value = val;
    activeNameSpan.textContent = activeTab.textContent;
    metaRadio.value = activeTab.textContent;
  }
  fechaActivaSpan.textContent = '--';
  fechaTitle.textContent = 'Fecha: ';
  renderAll();
})();
</script>

</body>
</html>
